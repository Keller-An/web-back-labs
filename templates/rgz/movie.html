{% extends "rgzbase.html" %}

{% block lab %}–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä - {{ movie.title }}{% endblock %}

{% block script %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block main %}
<div class="rgz-container">
    <div class="rgz-header">
        {% if movie.cover %}
            <img src="{{ url_for('static', filename=movie.cover) }}" alt="{{ movie.title }}" class="movie-cover">
        {% endif %}

        <h1>{{ movie.title }}</h1>
        <p>{{ movie.description }}</p>
        <p>‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ movie.duration }} –º–∏–Ω—É—Ç</p>
        <a href="/rgz/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–∏–ª—å–º–∞–º</a>
    </div>


    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="user-panel">
        {% if login %}
            <div class="user-info">
                <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ login }}</strong></p>
                {% if session.get('is_admin') %}
                    <p style="color: purple; font-weight: bold;">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                {% endif %}
            </div>
            <div class="user-actions">
                <a href="/rgz/" class="home-btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="/rgz/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        {% else %}
            <div class="user-info">
                <p>–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
            </div>
            <div class="user-actions">
                <a href="/rgz/login" class="login-btn">–í–æ–π—Ç–∏</a>
                <a href="/rgz/register" class="register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
        {% endif %}
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Å–µ–∞–Ω—Å–æ–≤ -->
    <div class="sessions-section">
        <h2>üìÖ –°–µ–∞–Ω—Å—ã —Ñ–∏–ª—å–º–∞</h2>

        {% if sessions|length == 0 %}
            <div class="no-sessions">
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å–º–∞</p>
            </div>
        {% else %}
            <div class="sessions-grid">
                {% for session in sessions %}
                <div class="session-card">
                    <div class="session-info">
                        <h3>–°–µ–∞–Ω—Å {{ loop.index }}</h3>
                        <p class="date">üìÖ {{ session.date }}</p>
                        <p class="price">üí∞ –¶–µ–Ω–∞: <strong>{{ session.price }} ‚ÇΩ</strong></p>
                        <p class="status {% if session.is_past %}past{% else %}future{% endif %}">
                            {% if session.is_past %}‚ùå –°–µ–∞–Ω—Å –∑–∞–≤–µ—Ä—à—ë–Ω{% else %}‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% endif %}
                        </p>

                    </div>

                    <div class="session-actions">
                        <a href="{% if not session.is_past %}/rgz/booking/{{ session.id }}{% else %}#{% endif %}" 
                            class="book-btn {% if session.is_past %}disabled{% endif %}">
                            {% if session.is_past %}
                                üîí –°–µ–∞–Ω—Å –∑–∞–≤–µ—Ä—à—ë–Ω
                            {% else %}
                                {% if login %}üéüÔ∏è –í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–∞{% else %}üîí –í–æ–π—Ç–∏ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% endif %}
                            {% endif %}
                        </a>


                        {% if session.get('is_admin') %}
                            <button onclick="deleteSession({{ session.id }})" class="delete-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<script>
    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞ (–∞–¥–º–∏–Ω)
    async function deleteSession(sessionId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ–∞–Ω—Å? –í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã.')) return;

        try {
            const response = await fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'admin_delete_session',
                    params: { session_id: sessionId },
                    id: 1
                })
            });

            const result = await response.json();
            if (result.result) {
                alert('–°–µ–∞–Ω—Å —É–¥–∞–ª–µ–Ω');
                location.reload();
            } else if (result.error) {
                alert('–û—à–∏–±–∫–∞: ' + result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞');
        }
    }
</script>
{% endblock %}
