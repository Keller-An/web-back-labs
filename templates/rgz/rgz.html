{% extends "rgzbase.html" %}

{% block lab %}–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä - –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block script %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block main %}
<div class="rgz-container">
    <div class="rgz-header">
        <h1>üé¨ –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä "–ö–∏–Ω–æ –∏ —Ç–æ—á–∫–∞"</h1>
        <p>–û–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤</p>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="user-panel">
        {% if login %}
            <div class="user-info">
                <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ login }}</strong></p>
                {% if session.get('is_admin') %}
                    <p style="color: purple; font-weight: bold;">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                {% endif %}
            </div>
            <div class="user-actions">
                <a href="/rgz/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
                {% if not session.get('is_admin') %}
                    <button onclick="deleteAccount()" class="delete-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                {% endif %}
            </div>
        {% else %}
            <div class="user-info">
                <p>–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
            </div>
            <div class="user-actions">
                <a href="/rgz/login" class="login-btn">–í–æ–π—Ç–∏</a>
                <a href="/rgz/register" class="register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
        {% endif %}
    </div>


<div class="movies-section">
    <h2>üé¨ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å–º—ã</h2>

    {% if movies|length == 0 %}
        <p class="no-movies">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤</p>
    {% else %}
        <div class="movies-grid">
            {% for movie in movies %}
            <div class="movie-card">
                <div class="movie-header">
                    <h3>{{ movie.title }}</h3>
                    <span class="duration">{{ movie.duration }} –º–∏–Ω.</span>
                </div>
                <div class="movie-body">
                    {% if movie.cover %}
                        <img src="{{ url_for('static', filename=movie.cover) }}" alt="{{ movie.title }}" class="movie-cover">
                    {% endif %}

                    <p>{{ movie.description }}</p>
                </div>
                <div class="movie-footer">
                    <a href="/rgz/movie/{{ movie.id }}">
                        <button class="sessions-btn">üìÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ–∞–Ω—Å—ã</button>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %} 
</div>

    <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    {% if session.get('is_admin') %}
    <div class="admin-panel">
        <h3>üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
        <div class="admin-controls">
            <button onclick="showAddMovieForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</button>
            <button onclick="showAddSessionForm()">üé´ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∞–Ω—Å</button>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞ -->
        <div id="add-movie-form" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc;">
            <h4>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</h4>
            <div>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="movie-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞">
            </div>
            <div>
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="movie-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            </div>
            <div>
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω):</label>
                <input type="number" id="movie-duration" placeholder="120" min="1">
            </div>
            <button onclick="addMovie()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="hideAddMovieForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞ -->
        <div id="add-session-form" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc;">
            <h4>–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∞–Ω—Å</h4>
            <div>
                <label>–§–∏–ª—å–º:</label>
                <select id="session-movie">
                    {% for movie in movies %}
                    <option value="{{ movie.id }}">{{ movie.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>–î–∞—Ç–∞:</label>
                <input type="date" id="session-date">
            </div>
            <div>
                <label>–í—Ä–µ–º—è:</label>
                <input type="time" id="session-time">
            </div>
            <div>
                <label>–¶–µ–Ω–∞:</label>
                <input type="number" id="session-price" placeholder="500" min="1">
            </div>
            <button onclick="addSession()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="hideAddSessionForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    {% endif %}
</div>


    <script>
        // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
        async function deleteAccount() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã.')) {
                return;
            }
            
            try {
                const response = await fetch('/rgz/api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'delete_account',
                        params: {},
                        id: 1
                    })
                });
                
                const result = await response.json();
                if (result.result) {
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω');
                    window.location.href = '/rgz/login';
                } else if (result.error) {
                    alert('–û—à–∏–±–∫–∞: ' + result.error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function showAddMovieForm() {
            document.getElementById('add-movie-form').style.display = 'block';
            document.getElementById('add-session-form').style.display = 'none';
        }
        
        function hideAddMovieForm() {
            document.getElementById('add-movie-form').style.display = 'none';
        }
        
        function showAddSessionForm() {
            document.getElementById('add-session-form').style.display = 'block';
            document.getElementById('add-movie-form').style.display = 'none';
        }
        
        function hideAddSessionForm() {
            document.getElementById('add-session-form').style.display = 'none';
        }
        
        async function addMovie() {
            const title = document.getElementById('movie-title').value.trim();
            const description = document.getElementById('movie-description').value.trim();
            const duration = parseInt(document.getElementById('movie-duration').value);
            
            if (!title || !duration || duration <= 0) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                return;
            }
            
            try {
                const response = await fetch('/rgz/api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'admin_add_movie',
                        params: {title, description, duration},
                        id: 1
                    })
                });
                
                const result = await response.json();
                if (result.result) {
                    alert('–§–∏–ª—å–º –¥–æ–±–∞–≤–ª–µ–Ω');
                    location.reload();
                } else if (result.error) {
                    alert('–û—à–∏–±–∫–∞: ' + result.error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞');
            }
        }
        
        async function addSession() {
            const movieId = document.getElementById('session-movie').value;
            const date = document.getElementById('session-date').value;
            const time = document.getElementById('session-time').value;
            const price = parseFloat(document.getElementById('session-price').value);
            
            if (!movieId || !date || !time || !price || price <= 0) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                return;
            }
            
            try {
                const response = await fetch('/rgz/api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'admin_add_session',
                        params: {movie_id: movieId, date, time, price},
                        id: 1
                    })
                });
                
                const result = await response.json();
                if (result.result) {
                    alert('–°–µ–∞–Ω—Å –¥–æ–±–∞–≤–ª–µ–Ω');
                    hideAddSessionForm();
                } else if (result.error) {
                    alert('–û—à–∏–±–∫–∞: ' + result.error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞');
            }
        }
    </script>
{% endblock %}