{% extends "rgzbase.html" %}

{% block lab %}–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block script %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz.css') }}">
{% endblock %}

{% block main %}
<div class="rgz-container">
    <div class="rgz-header">
        <h1>üéüÔ∏è –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç</h1>
        <p><strong>{{ session.movie_title }}</strong> - {{ session.date }}</p>
        <a href="/rgz/movie/{{ session.movie_id }}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–µ–∞–Ω—Å–∞–º</a>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–∞–Ω—Å–µ -->
    <div class="session-info">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–∞–Ω—Å–µ</h2>
        <div class="info-grid">
            <div class="info-item"><span class="label">–§–∏–ª—å–º:</span> <span class="value">{{ session.movie_title }}</span></div>
            <div class="info-item"><span class="label">–î–∞—Ç–∞:</span> <span class="value">{{ session.date }}</span></div>
            <div class="info-item"><span class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> <span class="value">{{ session.duration }} –º–∏–Ω—É—Ç</span></div>
            <div class="info-item"><span class="label">–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ:</span> <span class="value price">{{ session.price }} ‚ÇΩ</span></div>
        </div>
    </div>

    <!-- –°—Ö–µ–º–∞ –∑–∞–ª–∞ -->
    <div class="cinema-hall">
        <h2>üé¨ –°—Ö–µ–º–∞ –∑–∞–ª–∞ (30 –º–µ—Å—Ç)</h2>
        <div class="screen">üé¨ –≠–ö–†–ê–ù üé¨</div>
        <div class="seats-grid" id="seats-grid"></div>
        <div class="legend">
            <div class="legend-item"><div class="seat free"></div> <span>–°–≤–æ–±–æ–¥–Ω–æ</span></div>
            <div class="legend-item"><div class="seat selected"></div> <span>–í–∞—à–∏ –º–µ—Å—Ç–∞</span></div>
            <div class="legend-item"><div class="seat occupied"></div> <span>–ó–∞–Ω—è—Ç–æ</span></div>
        </div>
    </div>

    <!-- –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div class="booking-section">
        <h2>üìã –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <div class="booking-info">
            <div class="selected-seats">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:</h3>
                <div id="selected-seats-list">
                    {% if user_seats|length > 0 %}
                        {{ user_seats|sort|join(', ') }}
                    {% else %}
                        <em>–ú–µ—Å—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</em>
                    {% endif %}
                </div>
            </div>
            <div class="summary">
                <div class="summary-item"><span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç:</span> <strong id="selected-count">{{ user_seats|length }}</strong></div>
                <div class="summary-item"><span>–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ:</span> <strong>{{ session.price }} ‚ÇΩ</strong></div>
                <div class="summary-item total"><span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> <strong id="total-price">{{ user_seats|length * session.price }} ‚ÇΩ</strong></div>
                <div class="summary-item limit"><span>–õ–∏–º–∏—Ç:</span> <strong>5 –º–µ—Å—Ç –º–∞–∫—Å–∏–º—É–º</strong></div>
            </div>
        

            {% if login %}
                {% if not session.get('is_admin') %}
                    <div class="booking-actions">
                        <button onclick="updateBooking()" class="confirm-btn" id="confirm-btn">
                            {% if user_seats|length > 0 %}–û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω—å{% else %}–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                        </button>
                        {% if user_seats|length > 0 %}
                            <button onclick="cancelAll()" class="cancel-btn">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ</button>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="admin-note">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–∞</p>
                {% endif %}
            {% else %}
                <p class="auth-required">üîí –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ 
                    <a href="/rgz/login?redirect=/rgz/booking/{{ session.id }}">–≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
                </p>
            {% endif %}
        </div>
    </div>

<!-- –ó–∞–Ω—è—Ç—ã–µ –º–µ—Å—Ç–∞ -->
<div class="occupied-seats">
    <h3>–ó–∞–Ω—è—Ç—ã–µ –º–µ—Å—Ç–∞:</h3>
    {% if booked_seats|length > 0 %}
        <div class="occupied-list">
            {% for seat in booked_seats %}
                <div class="occupied-item">
                    <div class="seat-info">
                        <span class="seat-number">üí∫ –ú–µ—Å—Ç–æ {{ seat.seat_number }}</span>
                        <span class="user-name">üë§ {{ seat.full_name }}</span>
                        {% if session.get('is_admin') %}
                            <span class="admin-controls">
                                <button onclick="adminCancelBooking({{ seat.id }})" 
                                        class="admin-cancel-btn" 
                                        title="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ seat.full_name }}">
                                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –º–µ—Å—Ç–∞</p>
    {% endif %}
</div>

<script>
    const sessionId = {{ session.id }};
    const seatPrice = {{ session.price }};
    const isAdmin = {{ 'true' if session.get('is_admin', False) else 'false' }};
    const isLoggedIn = {{ 'true' if session.get('user_id') else 'false' }};
    const isAdminBool = (isAdmin === true || isAdmin === 'true');
    const isLoggedInBool = (isLoggedIn === true || isLoggedIn === 'true');
    if (!isLoggedInBool || isAdminBool) {
        alert('–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'); 
        return; 
    }
    let selectedSeats = {{ user_seats|tojson }};
    let bookedSeats = {{ booked_seats|map(attribute='seat_number')|list|tojson }};
    const bookedInfoArray = {{ booked_seats|tojson }};

    async function callApi(method, params = {}) {
        const response = await fetch('/rgz/api', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({jsonrpc: '2.0', method, params, id: Math.floor(Math.random()*1000)})
        });
        return await response.json();
    }

    function createSeatsGrid() {
        const grid = document.getElementById('seats-grid');
        grid.innerHTML = '';
        for (let row = 1; row <= 5; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seats-row';
            rowDiv.innerHTML = `<div class="row-label">–†—è–¥ ${row}</div>`;
            for (let seatNum = 1; seatNum <= 6; seatNum++) {
                const seatNumber = (row - 1) * 6 + seatNum;
                const seatBtn = document.createElement('button');
                seatBtn.className = 'seat';
                seatBtn.textContent = seatNumber;
                seatBtn.dataset.seat = seatNumber;

                if (bookedSeats.includes(seatNumber)) {
                    seatBtn.classList.add('occupied');
                    seatBtn.disabled = true;
                    const bookedInfo = bookedInfoArray.find(b => b.seat_number === seatNumber);
                    if (bookedInfo) seatBtn.title = `–ó–∞–Ω—è—Ç–æ: ${bookedInfo.full_name}`;
                } else {
                    seatBtn.classList.add('free');
                    if (isLoggedIn && !isAdmin) seatBtn.onclick = () => toggleSeat(seatNumber);
                }

                if (selectedSeats.includes(seatNumber)) {
                    seatBtn.classList.add('selected');
                    seatBtn.classList.remove('free');
                }

                rowDiv.appendChild(seatBtn);
            }
            grid.appendChild(rowDiv);
        }
        updateSummary();
    }

    function toggleSeat(seatNumber) {
        if (!isLoggedIn || isAdmin) { 
            alert('–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'); 
            return; 
        }

        const seatIndex = selectedSeats.indexOf(seatNumber);

        // –ï—Å–ª–∏ –º–µ—Å—Ç–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ
        if (seatIndex !== -1) {
            selectedSeats.splice(seatIndex, 1);
            updateSummary();
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ —Å—Ä–∞–∑—É
            const btn = document.querySelector(`.seat[data-seat='${seatNumber}']`);
            if (btn) {
                btn.classList.remove('selected');
                btn.classList.add('free');
            }
            return; 
        }

        // –ï—Å–ª–∏ –º–µ—Å—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –≤—ã–¥–µ–ª—è–µ–º
        selectedSeats.push(seatNumber);
        updateSummary();
        const btn = document.querySelector(`.seat[data-seat='${seatNumber}']`);
        if (btn) {
            btn.classList.add('selected');
            btn.classList.remove('free');
        }
    }

    function updateSummary() {
        const count = selectedSeats.length;
        const total = count * seatPrice;
        document.getElementById('selected-count').textContent = count;
        document.getElementById('total-price').textContent = total + ' ‚ÇΩ';
        const confirmBtn = document.getElementById('confirm-btn');
        if (confirmBtn) {
            confirmBtn.disabled = count === 0;
            confirmBtn.textContent = count > 0 ? '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å' : '–û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω—å';
        }
        const seatsList = document.getElementById('selected-seats-list');
        if (seatsList) seatsList.innerHTML = count > 0 ? selectedSeats.sort((a,b)=>a-b).join(', ') : '<em>–ú–µ—Å—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</em>';
    }

    async function updateBooking() {
        if (selectedSeats.length === 0) { 
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞'); 
            return; 
        }
        if (selectedSeats.length > 5) { 
            alert('–ú–∞–∫—Å–∏–º—É–º 5 –º–µ—Å—Ç'); 
            return; 
        }

        try {
            const result = await callApi('toggle_booking', { 
                session_id: sessionId, 
                seat_numbers: selectedSeats
            });

            if (result.error) {
                alert(result.error.message);
            } else {
                alert('–ú–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã!');
                location.reload(); 
            }
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏');
        }
    }


    async function cancelAll() {
        if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è?')) return;
        try {
            for (const seat of [...selectedSeats]) {
                await callApi('toggle_booking', { session_id: sessionId, seat_number: seat, action_type: 'cancel' });
            }
            alert('–í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã');
            location.reload();
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
        }
    }



    async function adminCancelBooking(seatNumber) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ ${seatNumber}?`)) {
            return;
        }

        try {
            // –ü–æ–ª—É—á–∞–µ–º ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞
            const bookedInfo = bookedInfoArray.find(b => b.seat_number === seatNumber);
            if (!bookedInfo || !bookedInfo.id) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏');
                return;
            }

            const result = await callApi('admin_cancel_booking', {
                booking_id: bookedInfo.id
            });

            if (result.result && result.result.success) {
                alert(`–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ ${seatNumber} –æ—Ç–º–µ–Ω–µ–Ω–æ!`);
                location.reload();
            } else if (result.error) {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + result.error.message);
            }
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
    }


    async function adminCancelAllBookings() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –í–°–ï –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —ç—Ç–æ–º —Å–µ–∞–Ω—Å–µ?')) {
            return;
        }

        try {
            const result = await callApi('admin_cancel_all_bookings', {
                session_id: sessionId
            });

            if (result.result && result.result.success) {
                alert('–í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã!');
                location.reload();
            } else if (result.error) {
                alert('–û—à–∏–±–∫–∞: ' + result.error.message);
            }
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
        }
    }
    

    document.addEventListener('DOMContentLoaded', createSeatsGrid);
</script>

<style>
    .seats-grid { display: flex; flex-direction: column; gap: 5px; margin-bottom: 20px; }
    .seats-row { display: flex; gap: 5px; align-items: center; }
    .seat { width: 40px; height: 40px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .seat.free { background-color: #a0e7a0; }
    .seat.selected { background-color: #ffd700; }
    .seat.occupied { background-color: #e07a7a; cursor: not-allowed; }
    .screen { text-align: center; margin-bottom: 10px; font-weight: bold; }
    .row-label { width: 60px; font-weight: bold; text-align: right; margin-right: 5px; }
    .legend { display: flex; gap: 20px; margin-top: 10px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .booking-actions { margin-top: 10px; display: flex; gap: 10px; }
    .confirm-btn, .cancel-btn { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; }
    .confirm-btn { background-color: #4caf50; color: white; }
    .cancel-btn { background-color: #f44336; color: white; }
</style>
{% endblock %}
